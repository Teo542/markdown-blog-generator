{% extends "admin_base.html" %}

{% block title %}{% if post %}Edit Post{% else %}New Post{% endif %}{% endblock %}

{% block content %}
<div class="editor-page">
    <form method="POST" class="editor-form">
        <div class="editor-header">
            <a href="{{ url_for('dashboard') }}" class="back-link">&larr; Back</a>
            <h1>{% if post %}Edit Post{% else %}New Post{% endif %}</h1>
        </div>

        <div class="form-row">
            <div class="form-group flex-grow">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" value="{{ post.title if post else '' }}" required placeholder="Post title">
            </div>
            <div class="form-group">
                <label for="slug">Slug</label>
                <input type="text" id="slug" name="slug" value="{{ post.slug if post else '' }}" placeholder="auto-generated">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" value="{{ post.date if post else today }}">
            </div>
            <div class="form-group flex-grow">
                <label for="tags">Tags (comma-separated)</label>
                <input type="text" id="tags" name="tags" value="{{ post.tags_str if post else '' }}" placeholder="python, tutorial">
            </div>
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="publish" {% if not post or post.publish %}checked{% endif %}>
                    Publish
                </label>
            </div>
        </div>

        <div class="editor-container">
            <div class="editor-pane">
                <label for="content">Content (Markdown)</label>
                <textarea id="content" name="content" placeholder="Write your post in Markdown...">{{ post.content if post else '' }}</textarea>
                <div class="upload-zone" id="upload-zone">
                    Drop images here or click to upload
                    <input type="file" id="image-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="preview-pane">
                <label>Preview</label>
                <div id="preview" class="preview-content"></div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large">
                {% if post %}Save Changes{% else %}Create Post{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const titleInput = document.getElementById('title');
const slugInput = document.getElementById('slug');
const contentInput = document.getElementById('content');
const preview = document.getElementById('preview');
const uploadZone = document.getElementById('upload-zone');
const imageInput = document.getElementById('image-input');

// Auto-generate slug from title
titleInput.addEventListener('input', () => {
    if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        slugInput.value = titleInput.value
            .toLowerCase()
            .replace(/[^\w\s-]/g, '')
            .replace(/[\s_]+/g, '-')
            .replace(/-+/g, '-')
            .trim();
        slugInput.dataset.autoGenerated = 'true';
    }
});

slugInput.addEventListener('input', () => {
    slugInput.dataset.autoGenerated = 'false';
});

// Live preview
let previewTimeout;
contentInput.addEventListener('input', () => {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(updatePreview, 300);
});

async function updatePreview() {
    const formData = new FormData();
    formData.append('content', contentInput.value);
    try {
        const res = await fetch('/preview', { method: 'POST', body: formData });
        preview.innerHTML = await res.text();
    } catch (e) {
        preview.innerHTML = '<p class="error">Preview failed</p>';
    }
}

// Initial preview
updatePreview();

// Image upload
uploadZone.addEventListener('click', () => imageInput.click());
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        uploadImage(file);
    }
});
imageInput.addEventListener('change', () => {
    if (imageInput.files[0]) {
        uploadImage(imageInput.files[0]);
    }
});

async function uploadImage(file) {
    const formData = new FormData();
    formData.append('image', file);
    uploadZone.textContent = 'Uploading...';
    try {
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.markdown) {
            const pos = contentInput.selectionStart;
            const before = contentInput.value.substring(0, pos);
            const after = contentInput.value.substring(pos);
            contentInput.value = before + '\n' + data.markdown + '\n' + after;
            updatePreview();
            showToast('Image uploaded!');
        } else {
            showToast(data.error || 'Upload failed', true);
        }
    } catch (e) {
        showToast('Upload failed', true);
    }
    uploadZone.textContent = 'Drop images here or click to upload';
}
</script>
{% endblock %}
